generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String
  name         String?
  role         UserRole @default(USER)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  permissions  DocumentPermission[]
  auditLogs    AuditLog[]
  refreshTokens RefreshToken[]
  
  documents    Document[]  @relation("UserDocuments")  

  @@index([email])
}


enum UserRole {
  ADMIN
  USER
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  @@index([token])
}

model Document {
  id          String   @id @default(uuid())
  title       String
  ownerId     String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  owner       User     @relation("UserDocuments", fields: [ownerId], references: [id])
  permissions DocumentPermission[]
  operations  Operation[]
  versions    DocumentVersion[]
  assets      BinaryAsset[]
  auditLogs   AuditLog[]

  @@index([ownerId])
}

model DocumentPermission {
  id         String         @id @default(uuid())
  documentId String
  userId     String
  role       PermissionRole
  createdAt  DateTime       @default(now())

  document   Document       @relation(fields: [documentId], references: [id], onDelete: Cascade)
  user       User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([documentId, userId])
  @@index([documentId])
}

enum PermissionRole {
  OWNER
  EDITOR
  VIEWER
}

model Operation {
  id          String   @id @default(uuid())
  documentId  String
  userId      String
  update      Bytes
  stateVector Bytes
  createdAt   DateTime @default(now())

  document    Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([documentId, createdAt])
}

model DocumentVersion {
  id          String   @id @default(uuid())
  documentId  String
  snapshot    Bytes
  stateVector Bytes
  createdAt   DateTime @default(now())
  createdBy   String?
  label       String?

  document    Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([documentId, createdAt])
}

model BinaryAsset {
  id          String   @id @default(uuid())
  documentId  String
  filename    String
  mimeType    String
  size        Int
  storagePath String
  uploadedBy  String
  uploadedAt  DateTime @default(now())

  document    Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
}

model AuditLog {
  id         String      @id @default(uuid())
  documentId String?
  userId     String
  action     AuditAction
  metadata   Json?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime    @default(now())

  document   Document?   @relation(fields: [documentId], references: [id])
  user       User        @relation(fields: [userId], references: [id])

  @@index([documentId, createdAt])
}

enum AuditAction {
  DOCUMENT_CREATE
  DOCUMENT_UPDATE
  DOCUMENT_DELETE
  DOCUMENT_OPEN
  PERMISSION_GRANT
  PERMISSION_REVOKE
  VERSION_CREATE
  VERSION_REVERT
  USER_LOGIN
  USER_LOGOUT
  ASSET_UPLOAD
}
